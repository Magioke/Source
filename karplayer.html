<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>KAR Player Embedded</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #lyrics { margin-top: 20px; font-size: 1.2em; color: #c00; min-height: 3em; }
  button { font-size: 1em; padding: 10px 20px; margin-right: 10px; }
</style>
</head>
<body>

<h1>KAR Player Embedded</h1>
<p>Loading .kar file from URL and playing it with synced lyrics</p>

<button id="playBtn" disabled>Play</button>
<button id="stopBtn" disabled>Stop</button>
<div id="lyrics"></div>

<script src="https://cdn.jsdelivr.net/npm/midi-player-js@2.0.5/dist/MIDIPlayer.min.js"></script>

<script>
// URL to your .kar file on your server â€” change this:
const karUrl = 'https://magioke.github.io/Source/halaga.kar'; 

let player = null;
let lyricsDiv = document.getElementById('lyrics');
let playBtn = document.getElementById('playBtn');
let stopBtn = document.getElementById('stopBtn');

function parseLyrics(events) {
  // Extract lyrics meta events from MIDI file
  let lyrics = [];
  events.forEach(event => {
    if (event.name === 'Lyrics') {
      lyrics.push({time: event.playTime, text: event.data});
    }
  });
  return lyrics;
}

async function loadKar() {
  try {
    const response = await fetch(karUrl);
    if (!response.ok) throw new Error('Failed to load .kar file');
    const arrayBuffer = await response.arrayBuffer();
    const byteArray = new Uint8Array(arrayBuffer);

    player = new MidiPlayer.Player(event => {
      if (event.name === 'Lyrics') {
        // Show current lyrics line
        lyricsDiv.textContent = event.data;
      }
    });

    player.loadArrayBuffer(byteArray);

    playBtn.disabled = false;
    lyricsDiv.textContent = 'Loaded KAR file. Ready to play.';
  } catch (e) {
    lyricsDiv.textContent = 'Error loading KAR file: ' + e.message;
  }
}

playBtn.onclick = () => {
  if (!player) return;
  player.play();
  playBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  if (!player) return;
  player.stop();
  playBtn.disabled = false;
  stopBtn.disabled = true;
  lyricsDiv.textContent = 'Stopped.';
};

loadKar();
</script>

</body>
</html>
